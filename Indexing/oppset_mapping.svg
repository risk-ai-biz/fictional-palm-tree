<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#333"/>
    </marker>
    <style>
      .title { font: bold 22px sans-serif; fill: #111; }
      .subtitle { font: bold 16px sans-serif; fill: #111; }
      .label { font: 13px sans-serif; fill: #111; }
      .mono  { font: 12px monospace; fill: #111; }
      .box { fill: #f9fbff; stroke: #2c6af0; stroke-width: 1.5; rx: 8; }
      .group { fill: #f7f7f7; stroke: #bbb; stroke-width: 1; rx: 6; }
      .band { fill: #fffdf6; stroke: #d6b656; stroke-width: 1.5; rx: 6; }
      .array { fill: #f8fff9; stroke: #37a169; stroke-width: 1.5; rx: 6; }
      .hash { fill: #fff7fb; stroke: #c51b8a; stroke-width: 1.5; rx: 6; }
      .edge { stroke: #333; stroke-width: 1.5; marker-end: url(#arrow); fill: none; }
      .tick { stroke: #999; stroke-width: 1; }
    </style>
  </defs>

  <!-- Title -->
  <text x="30" y="40" class="title">Oppset / Order Indexing (Global ↔ Batch, Local Order Indices, Reconstitution)</text>

  <!-- GlobalOppsetIndex -->
  <rect x="30" y="70" width="540" height="170" class="box"/>
  <text x="50" y="95" class="subtitle">GlobalOppsetIndex</text>
  <text x="50" y="120" class="mono">columns: [global_oppset_id, date, sym, day_i32, sym_id, n_rows]</text>
  <text x="50" y="145" class="label">• Built once over the entire dataset</text>
  <text x="50" y="170" class="label">• Sorted by (day_i32, sym_id) ⇒ stable IDs for reassembly</text>
  <text x="50" y="195" class="mono">example: (0, 2025-01-01, AAPL, 739369, 12, 4), (1, 2025-01-02, MSFT, 739370, 34, 3)</text>

  <!-- Arrow to batch -->
  <path d="M570,155 C650,155 650,210 720,210" class="edge"/>

  <!-- Batch box -->
  <rect x="720" y="150" width="640" height="260" class="box"/>
  <text x="740" y="175" class="subtitle">Per-batch Local Index</text>
  <text x="740" y="200" class="mono">batch_oppset_index: [local_oppset_id, global_oppset_id, date, sym, day_i32, sym_id,</text>
  <text x="740" y="220" class="mono">                     row_start, row_end, n_rows, ord_start, ord_end, n_orders,</text>
  <text x="740" y="240" class="mono">                     ht_start, ht_size]</text>
  <text x="740" y="265" class="label">• local_oppset_id = 0..B-1 (within batch)</text>
  <text x="740" y="290" class="label">• Join to global_oppset_id via (day_i32, sym_id)</text>
  <text x="740" y="315" class="label">• row/order/hash offsets provide contiguous slices per oppset</text>

  <!-- rows_with_index band -->
  <rect x="30" y="280" width="660" height="130" class="band"/>
  <text x="50" y="300" class="subtitle">rows_with_index (batch)</text>
  <text x="50" y="320" class="mono">columns: [date, sym, ping_id, order_id, day_i32, sym_id, local_oppset_id, global_oppset_id, local_row, batch_row]</text>
  <text x="50" y="340" class="label">Contiguous row slices per oppset:</text>
  <!-- ticks for ds_row_offsets -->
  <line x1="60" y1="370" x2="60" y2="400" class="tick"/>
  <line x1="270" y1="370" x2="270" y2="400" class="tick"/>
  <line x1="480" y1="370" x2="480" y2="400" class="tick"/>
  <line x1="690" y1="370" x2="690" y2="400" class="tick"/>
  <text x="52" y="415" class="mono">ds_row_offsets: [0</text>
  <text x="255" y="415" class="mono">, 4</text>
  <text x="465" y="415" class="mono">, 7</text>
  <text x="675" y="415" class="mono">]</text>
  <text x="120" y="365" class="mono">rows[0:4] → local_oppset_id=0</text>
  <text x="335" y="365" class="mono">rows[4:7] → local_oppset_id=1</text>

  <!-- order_ids_flat array -->
  <rect x="30" y="460" width="660" height="120" class="array"/>
  <text x="50" y="480" class="subtitle">order_ids_flat (Σ n_orders)</text>
  <text x="50" y="505" class="mono">ds_order_offsets: [0, 4, 7]</text>
  <!-- segment boxes -->
  <rect x="60" y="520" width="260" height="40" fill="#e6fbec" stroke="#37a169" rx="4"/>
  <rect x="340" y="520" width="200" height="40" fill="#e6fbec" stroke="#37a169" rx="4"/>
  <text x="70" y="545" class="mono">oppset 0 → [100, 101, 103, 104]</text>
  <text x="350" y="545" class="mono">oppset 1 → [200, 201, 203]</text>

  <!-- parent_local_idx_flat -->
  <rect x="30" y="600" width="660" height="80" class="array"/>
  <text x="50" y="622" class="subtitle">parent_local_idx_flat (parallel to order_ids_flat)</text>
  <text x="50" y="645" class="mono">oppset 0 → [-1, 0, 1, 1]   |   oppset 1 → [-1, 0, 1]</text>

  <!-- Hash tables -->
  <rect x="720" y="440" width="640" height="240" class="hash"/>
  <text x="740" y="465" class="subtitle">Per-oppset hash tables (order_id → local_order_idx)</text>
  <text x="740" y="490" class="mono">ht_offsets: [0, 8, 16]   (example sizes)</text>
  <!-- slab 0 -->
  <rect x="740" y="505" width="280" height="60" fill="#fff" stroke="#c51b8a" rx="4"/>
  <text x="748" y="520" class="mono">local_oppset_id = 0 (ht_start=0, ht_size=8)</text>
  <text x="748" y="540" class="mono">keys: [100,101,103,104,·,·,·,·] → vals: [0,1,2,3, -1…]</text>
  <!-- slab 1 -->
  <rect x="1040" y="505" width="280" height="60" fill="#fff" stroke="#c51b8a" rx="4"/>
  <text x="1048" y="520" class="mono">local_oppset_id = 1 (ht_start=8, ht_size=8)</text>
  <text x="1048" y="540" class="mono">keys: [200,201,203,·,·,·,·,·] → vals: [0,1,2, -1…]</text>

  <!-- Reconstitution path -->
  <rect x="30" y="710" width="1330" height="240" class="group"/>
  <text x="50" y="735" class="subtitle">Reconstitution of worker outputs</text>
  <text x="50" y="760" class="mono">Worker emits: (local_oppset_id, local_order_idx, value)</text>
  <!-- steps -->
  <rect x="50" y="780" width="240" height="120" class="box"/>
  <text x="65" y="805" class="label">1) Map local_oppset_id →</text>
  <text x="65" y="825" class="label">   global_oppset_id via</text>
  <text x="65" y="845" class="label">   batch_oppset_index</text>

  <path d="M290,840 C340,840 360,840 410,840" class="edge"/>
  <rect x="410" y="780" width="260" height="120" class="box"/>
  <text x="425" y="805" class="label">2) Convert local_order_idx →</text>
  <text x="425" y="825" class="label">   order_id via ds_order_offsets</text>
  <text x="425" y="845" class="label">   + order_ids_flat slice</text>

  <path d="M670,840 C720,840 740,840 790,840" class="edge"/>
  <rect x="790" y="780" width="260" height="120" class="box"/>
  <text x="805" y="805" class="label">3) Now have (global_oppset_id,</text>
  <text x="805" y="825" class="label">   order_id, value)</text>
  <text x="805" y="845" class="label">   → join to global index</text>

  <path d="M1050,840 C1100,840 1120,840 1170,840" class="edge"/>
  <rect x="1170" y="780" width="170" height="120" class="box"/>
  <text x="1185" y="820" class="label">(date, sym)</text>
  <text x="1185" y="845" class="label">or original rows</text>
</svg>
